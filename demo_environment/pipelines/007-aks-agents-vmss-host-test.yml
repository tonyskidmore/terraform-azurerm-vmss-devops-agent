---

name: "container-test"

trigger: none

variables:
  - group: build
  - name: serviceConnection
    value: "demo-vmss"

pool:
  name: 'vmss-bootstrap-pool'


jobs:
  - job: test
    displayName: "Test AKS Job"
    continueOnError: false

    steps:

      - checkout: self

      - script: |
          source /etc/os-release
          printf "Running on: %s\n" "$PRETTY_NAME"
        displayName: Check operating system version

      - script: |
          echo "Build index: $(build_index)"
        displayName: Check build index

      - script: |
          sudo az aks install-cli
        displayName: Install kubectl

      - task: AzureCLI@2
        inputs:
          azureSubscription: $(serviceConnection)
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            az aks get-credentials --resource-group rg-demo-azure-devops-vmss --name test-cluster
        displayName: Get AKS credentials

      # - task: AzureCLI@2
      #   inputs:
      #     azureSubscription: $(serviceConnection)
      #     scriptType: 'bash'
      #     scriptLocation: 'inlineScript'
      #     inlineScript: |
      #       kubectl get nodes
      #   displayName: Get AKS nodes

      - script: |
          kubectl get nodes
        displayName: Get AKS nodes

      - script: |
          kubectl get secrets
        displayName: Get K8s secrets

      - script: |
          kubectl create secret generic pipeline-auth \
            --from-literal=AZP_URL=$(ado_org) \
            --from-literal=AZP_TOKEN=$(ado_ext_pat) || echo "Secret already exists"
        displayName: Create K8s secret

      # - script: |
      #     kubectl apply \
      #     -f https://raw.githubusercontent.com/lippertmarkus/keda-azure-pipelines-agent/main/kubernetes/job-setup.yml
      #   displayName: Register agent

      - script: |
          curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
          sudo apt-get install apt-transport-https --yes
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
          sudo apt-get update
          sudo apt-get install helm
        displayName: Install helm

      - script: |
          helm repo add kedacore https://kedacore.github.io/charts
          helm repo update
          helm install keda kedacore/keda --namespace keda --create-namespace
        displayName: Install KEDA

      - script: |
          kubectl apply \
            -f https://raw.githubusercontent.com/lippertmarkus/keda-azure-pipelines-agent/main/kubernetes/scaledjob.yml
        displayName: Add ScaledJob
